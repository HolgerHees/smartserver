# ***** CHECK *****
- name: check influxdb service
  import_tasks: roles/influxdb/tasks/wait_until_ready.yml

# ***** DISABLE APPS *****
- name: check users
  shell: "docker exec influxdb sh -c \"influx user list\""
  register: influxdb_user_result
  changed_when: False
  tags: [ 'user' ]

- name: add new user
  shell: "docker exec influxdb sh -c \"influx user create --name {{item}} --password {{vault_userpasswords[item].web_password}} --org default-org\""
  when: "item not in influxdb_user_result.stdout and 'admin' in userdata[item].groups"
  with_items: "{{userdata}}"
  tags: [ 'user' ]

- name: check auth
  shell: "docker exec influxdb sh -c \"influx auth list --org default-org\""
  register: influxdb_auth_result
  changed_when: False
  tags: [ 'user' ]
  
- name: add new auth
  shell: "docker exec influxdb sh -c \"influx auth create --description \\\"{{item}}'s Token\\\" --user {{item}} --org default-org \
  --read-buckets \
  --read-checks \
  --read-dashboards \
  --read-dbrps \
  --read-notificationEndpoints \
  --read-notificationRules \
  --read-orgs \
  --read-tasks \
  --read-telegrafs \
  --read-user \
  --write-buckets \
  --write-checks \
  --write-dashboards \
  --write-dbrps \
  --write-notificationEndpoints \
  --write-notificationRules \
  --write-orgs \
  --write-tasks \
  --write-telegrafs \
  --write-user\""
  when: "item not in influxdb_auth_result.stdout and 'admin' in userdata[item].groups"
  with_items: "{{userdata}}"
  tags: [ 'user' ]


  
  
