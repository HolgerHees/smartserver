# ***** CHECK *****
- name: check influxdb service
  import_tasks: roles/influxdb/tasks/wait_until_ready.yml

# ***** DISABLE APPS *****
- name: check users
  shell: "docker exec influxdb sh -c \"influx user list\""
  register: influxdb_user_result
  changed_when: False
  tags: [ 'user' ]

- name: add new user
  shell: "docker exec influxdb sh -c \"influx user create --name {{item}} --password {{vault_userpasswords[item].web_password}} --org default-org\""
  when: "item not in influxdb_user_result.stdout and 'admin' in userdata[item].groups"
  with_items: "{{userdata}}"
  tags: [ 'user' ]

- name: update user password
  shell: |
    spawn docker exec -it influxdb sh -c "influx user password --name {{item}}"
    expect "Please type your new password:"
    send "{{vault_userpasswords[item].web_password}}\n" 
    expect "Please type your new password again:"
    send "{{vault_userpasswords[item].web_password}}\n" 
    exit 0
  when: "item in influxdb_user_result.stdout"
  with_items: "{{userdata}}"
  changed_when: False
  tags: [ 'user' ]

- name: check auth
  shell: "docker exec influxdb sh -c \"influx auth list --org default-org\""
  register: influxdb_auth_result
  changed_when: False
  tags: [ 'user' ]
  
- name: add new auth
  shell: "docker exec influxdb sh -c \"influx auth create --description \\\"{{item}}'s Token\\\" --user {{item}} --org default-org --operator\""
  when: "item not in influxdb_auth_result.stdout and 'admin' in userdata[item].groups"
  with_items: "{{userdata}}"
  tags: [ 'user' ]


  
  
