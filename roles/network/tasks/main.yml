- name: set hostname
  shell: 'hostname {{server_name}}'
  changed_when: "ansible_hostname != server_name"

- name: set hostname file
  copy:
    content: "{{server_name}}"
    dest: /etc/hostname
    force: yes
    owner: root
    group: root
    mode: 0644

- name: set hosts config
  lineinfile:
    path: /etc/hosts
    regexp: '^{{server_ip}} '
    line: '{{server_ip}} {{server_name}}'
    
# needed to fix "netdev budget ran outs" on a atom cpu
# https://github.com/netdata/netdata/issues/4624
- name: set netdev budget
  lineinfile:
    path: /etc/sysctl.conf
    regexp: '^net\.core\.netdev_budget_usecs\s*='
    line: 'net.core.netdev_budget_usecs = 20000'
  register: netdevchanged

- name: set ipv6
  lineinfile:
    path: /etc/sysctl.conf
    regexp: '^net\.ipv6\.conf\.all\.disable_ipv6\s*='
    line: 'net.ipv6.conf.all.disable_ipv6 = 0'
  register: ipv6changed
    
- name: refresh sysctl to activate ipv6 => netdev or ipv6 changed
  shell: sysctl -p
  when: netdevchanged.changed or ipv6changed.changed
  
#- name: set network intferface eth0
#  nmcli:
#    conn_name: eth0
#    ifname: eth0
#    type: ethernet
#    ip4: "{{server_ip}}/24"
#    gw4: "{{server_gateway}}"
#    dns4: "{{dns1}} {{dns2}}"
#    state: present

#- name: set network intferface eth0:1
#  nmcli:
#    conn_name: eth0:1
#    ifname: eth0
#    type: ethernet
#    ip4: "{{cloud_net1_server_ip}}/24"
#    gw4: "{{cloud_net1_gateway}}"
#    state: present
