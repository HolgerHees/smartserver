- name: set version
  set_fact:
    curator_version: "5.8.1"
  tags: [ 'update_notifier_configs' ]

- name: checkout project
  git:
#    accept_hostkey: yes
    repo: 'https://github.com/elastic/curator.git'
    dest: '{{global_build}}curator'
#    force: yes
    version: 'v{{curator_version}}'

- name: register existing build images
  shell: "docker images | grep -oP \"<none>\\s+[A-z0-9]+\\s+\" | grep -oP \"\\s+\\K[A-z0-9]+\""
  register: image_result_before
  changed_when: no
  
- name: build docker image
  vars:
    name: "curator"
    image_name: "custom_curator"
    image_version: "{{curator_version}}"
    files: []
  import_tasks: roles/container/tasks/build_docker_image.yml
  
- name: register existing build images
  shell: "docker images | grep -oP \"<none>\\s+[A-z0-9]+\\s+\" | grep -oP \"\\s+\\K[A-z0-9]+\""
  register: image_result_after
  changed_when: no

- name: clean build images
  shell: "docker image rm {{item}}"
  with_items: "{{ image_result_after.stdout_lines | difference(image_result_before.stdout_lines) }}"
  
- name: connect curator with elasticsearch
  docker_network:
    name: curator_databases
    connected:
      - elasticsearch
    appends: yes
  tags: ['elasticsearch']

- name: create docker container
  docker_container:
    name: curator
    image: "custom_curator:{{curator_version}}"
    state: present
#    recreate: true
    env:
      TZ: "{{timezone}}"
    log_driver: journald
    log_options:
      tag: curator
    entrypoint:
      - "/bin/sh"
      - "-c"
      - "\"trap : TERM INT; (while true; do sleep 360; done) & wait\""
    networks:
      - name: curator_databases
    networks_cli_compatible: yes

# ***** FINALIZE *****
#- name: copy fluentd config
#  vars:
#    config_file: "templates/etc/fluent/_.ansible.d/kibana.conf"
#  import_tasks: roles/fluentd/tasks/add_config.yml
    
- name: register update notifier
  vars:
    name: "curator"
    type: "github"
    url: "https://github.com/elastic/curator/releases"
    config: {
      project: "elastic/curator", 
      pattern: "^v([0-9\\.]+)$",
      version: "{{curator_version}}" 
    }
  import_tasks: roles/update_notifier/tasks/add_notifier.yml
