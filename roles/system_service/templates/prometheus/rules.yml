groups:
- name: system_service
  rules:
  - alert: System service container availability
    expr: 'system_service_state{job="system_service",hostname=""} == 0'
    for: 0m
    labels:
      notifyGroup: "system_service"
      severity: critical
    annotations:
      summary: "System service '{{'{{'}} $labels.type {{'}}'}}'"

  - alert: System service device availability
    expr: 'system_service_state{job="system_service",hostname!=""} == 0'
    for: 0m
    labels:
      notifyGroup: "system_service"
      severity: critical
    annotations:
      summary: "System service device '{{'{{'}} $labels.type {{'}}'}}' - '{{'{{'}} $labels.hostname {{'}}'}}'"

- name: wan_connection
  rules:
  - alert: Speedtest is not working
    expr: 'absent_over_time(system_service_speedtest[70m])'
    for: 0m
    labels:
      notifyGroup: "wan_connection"
      severity: critical
    annotations:
      summary: "Speedtest is not working. Maybe your wan connection is broken."

  - alert: WAN connection download speed is too low
    expr: 'system_service_speedtest{type="downstream_rate"} < max_over_time(system_service_speedtest{type="downstream_rate"}[30d]) * 0.75
           and (
             max_over_time(system_service_speedtest{type="downstream_rate"}[4h]) < max_over_time(system_service_speedtest{type="downstream_rate"}[30d]) * 0.5
             or avg_over_time(system_service_speedtest{type="downstream_rate"}[4h]) < avg_over_time(system_service_speedtest{type="downstream_rate"}[30d]) * 0.75
           )'
    for: 0m
    labels:
      notifyGroup: "wan_connection"
      severity: critical
    annotations:
      summary: "WAN connection download speed is {{'{{'}}printf \"%d\" $value{{'}}'}} mbit/s"

  - alert: WAN connection upload speed is too low
    expr: 'system_service_speedtest{type="upstream_rate"} < max_over_time(system_service_speedtest{type="upstream_rate"}[30d]) * 0.75
           and (
             max_over_time(system_service_speedtest{type="upstream_rate"}[4h]) < max_over_time(system_service_speedtest{type="upstream_rate"}[30d]) * 0.5
             or avg_over_time(system_service_speedtest{type="upstream_rate"}[4h]) < avg_over_time(system_service_speedtest{type="upstream_rate"}[30d]) * 0.75
           )'
    for: 0m
    labels:
      notifyGroup: "wan_connection"
      severity: critical
    annotations:
      summary: "WAN connection upload speed is {{'{{'}}printf \"%d\" $value{{'}}'}} mbit/s"

  - alert: WAN connection ping latency is too high
    expr: 'min_over_time(system_service_speedtest{type="ping"}[4h]) > min_over_time(system_service_speedtest{type="ping"}[30d]) * 2'
    for: 0m
    labels:
      notifyGroup: "wan_connection"
      severity: critical
    annotations:
      summary: "WAN connection ping latency is {{'{{'}}$value{{'}}'}} ms"
