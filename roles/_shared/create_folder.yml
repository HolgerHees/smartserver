- name: "_shared : prepare needed folder"
  file:
    path: '{{item.path}}'
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  register: "needed_folder_result"
  with_items: "{{needed_folder}}"

#- name: debug
#  debug:
#    msg: "{{needed_folder_result}}"

- name: "_shared : check recursive owner and group => needed folder changed"
  file:
    path: '{{item.1.path}}'
    state: directory
    owner: "{{item.1.owner}}"
    group: "{{item.1.group}}"
    recurse: yes
  when: "needed_folder_result.results[item.0].changed and ( 'owner' in needed_folder_result.results[item.0].diff.before.keys() or 'group' in needed_folder_result.results[item.0].diff.before.keys() )"
  with_indexed_items: "{{needed_folder}}"

