- name: set phpmyadmin version
  set_fact:
    phpmyadmin_version: '4.9.2'
    
- name: check installation
  stat:
    path: "{{htdocs_path}}mysql-phpMyAdmin-{{phpmyadmin_version}}-all-languages"
  register: phpmyadmin_exists
  changed_when: not phpmyadmin_exists.stat.exists
  
- name: install archive => phpmyadmin does not exists
  unarchive:
    src: "https://files.phpmyadmin.net/phpMyAdmin/{{phpmyadmin_version}}/phpMyAdmin-{{phpmyadmin_version}}-all-languages.zip"
    dest: "{{htdocs_path}}"
    remote_src: yes
    owner: "{{www_username}}"
    group: "{{www_group}}"
    mode: 0750
  when: not phpmyadmin_exists.stat.exists

- name: rename folder => phpmyadmin does not exists
  command: "mv {{htdocs_path}}phpMyAdmin-{{phpmyadmin_version}}-all-languages/ {{htdocs_path}}mysql-phpMyAdmin-{{phpmyadmin_version}}-all-languages"
  when: not phpmyadmin_exists.stat.exists
  
- name: set symbolic link => phpmyadmin does not exists
  file:
    src: "mysql-phpMyAdmin-{{phpmyadmin_version}}-all-languages"
    dest: "{{htdocs_path}}mysql"
    state: link
    follow: no
    owner: "{{www_username}}"
    group: "{{www_group}}"
  when: not phpmyadmin_exists.stat.exists
  
- name: copy config
  template:
    src: "templates/config.inc.php"
    dest: "{{htdocs_path}}mysql/config.inc.php"
    owner: "{{www_username}}"
    group: "{{www_group}}"
    mode: 0640

- name: prepare config folder
  file:
    path: "{{htdocs_path}}mysql/tmp"
    state: directory
    owner: "{{www_username}}"
    group: "{{www_group}}"
    mode: 0750
  
- name: set selinux configuration => is_fedora
  sefcontext:
    target: "{{htdocs_path}}mysql-phpMyAdmin-{{phpmyadmin_version}}-all-languages/tmp"
    setype: "httpd_sys_rw_content_t"
    seuser: "system_u"
    state: present
  register: sefcontext_result
  when: is_fedora|bool and not dockerized_apache

- name: reload selinux configuration => is_fedora
  shell: "restorecon {{htdocs_path}}mysql-phpMyAdmin-{{phpmyadmin_version}}-all-languages/tmp"
  when: is_fedora|bool and sefcontext_result.changed and not dockerized_apache
  
    
