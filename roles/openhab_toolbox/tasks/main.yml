- name: clone git
  git:
#    accept_hostkey: yes
    repo: 'https://github.com/HolgerHees/toolbox.git'
    dest: '{{projects_path}}toolbox'
    version: 'master'

- name: copy config => vault_active
  template:
    src: "roles/openhab_toolbox/templates/config.php"
    dest: "{{projects_path}}toolbox/_lib/config.php"
    owner: root
    group: root
    mode: 0644
  when: "vault_active|bool"
  
- name: set selinux configuration => is_fedora
  sefcontext:
    target: "{{projects_path}}toolbox(/.*)?"
    ftype: "a"
    setype: "httpd_sys_content_t"
    seuser: "system_u"
    state: present
  register: sefcontext_result
  when: is_fedora|bool

- name: reload selinux configuratio => is_fedora and sefcontext changed
  shell: "restorecon -irv {{projects_path}}toolbox"
  when: is_fedora|bool and sefcontext_result.changed

- name: set symbolic link to htdocs => vault_active
  file:
    src: "{{projects_path}}toolbox/web/"
    dest: "{{htdocs_path}}tools"
    state: link
    follow: no
    owner: "{{www_username}}"
    group: "{{www_group}}"  
  when: "vault_active|bool"
      
- name: check mysql service
  import_tasks: roles/mysql/tasks/wait_until_ready.yml

- name: check mysql table
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 -e 'SHOW TABLES FROM openhab;'\""
  register: mysql_data_exists
  changed_when: "'weather_forecast' not in mysql_data_exists.stdout"
  
- name: create missing table => weather_forecast table does not exists in database
  shell: "cat roles/openhab_toolbox/templates/weather_forecast.sql | docker exec -i mysql sh -c \"mysql -u root -h 127.0.0.1 openhab\""
  when: "'weather_forecast' not in mysql_data_exists.stdout"
  
# Weather data fetcher
- name: create cron job
  vars:
    name: "Weatherdata"
    cmd: "/usr/bin/php -f {{projects_path}}toolbox/cmd/dataProvider/fetchWeatherData.php"
    file: "ansible_openhab_toolbox"
    minute: "0"
  import_tasks: roles/cron/tasks/add_cronjob.yml
