- name: clone git
  git:
#    accept_hostkey: yes
    repo: 'https://github.com/HolgerHees/toolbox.git'
    dest: '{{projects_path}}toolbox'
    version: 'master'

- name: copy config
  template:
    src: "roles/openhab_toolbox/templates/config.php"
    dest: "{{projects_path}}toolbox/_lib/config.php"
    owner: root
    group: root
    mode: 0644
  when: "vault_active|bool"
  
- name: set symbolic link to htdocs
  file:
    src: "{{projects_path}}toolbox/web/"
    dest: "{{htdocs_path}}tools"
    state: link
    owner: "{{www_username}}"
    group: "{{www_group}}"  
  when: "vault_active|bool"
      
- name: check mysql service
  include_role:
    name: mysql
    tasks_from: wait_until_ready

- name: check mysql table
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 -e 'SHOW TABLES FROM openhab;'\""
  register: mysql_data_exists
  changed_when: "'weather_forecast' not in mysql_data_exists.stdout"
  
- name: create missing table
  shell: "cat roles/openhab_toolbox/templates/weather_forecast.sql | docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 openhab\""
  when: "'weather_forecast' not in mysql_data_exists.stdout"
  
# Weather data fetcher
- name: create cron job
  vars:
    name: "Weatherdata"
    cmd: "/usr/bin/php -f {{projects_path}}toolbox/cmd/dataProvider/fetchWeatherData.php"
    file: "ansible_openhab_toolbox"
    minute: "0"
  include_role:
    name: cron
    tasks_from: add_cronjob
