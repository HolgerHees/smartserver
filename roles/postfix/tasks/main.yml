- name: install required fedora packages
  yum:
    name: [
        postfix
      , cyrus-sasl
      , cyrus-sasl-plain
    ]
    state: present
  notify: "restart postfix"
  when: ansible_distribution == 'Fedora'

- name: install required suse packages
  zypper:
    name: [
        postfix
      , cyrus-sasl
      , cyrus-sasl-plain
    ]
    state: present
  notify: "restart postfix"
  when: ansible_distribution == 'openSUSE Leap'
  
#- name: set config
#  lineinfile:
#    path: /etc/sysconfig/postfix
#    regexp: '^{{item.field}}'
#    line: '{{item.field}}"{{item.value}}"'
#  with_items:
#    #- { field: 'POSTFIX_LISTEN=', value: '' }
#    - { field: 'POSTFIX_INET_PROTO=', value: 'all' }
#    - { field: 'POSTFIX_RELAYHOST=', value: '[smtp.gmail.com]:587' }
#    - { field: 'POSTFIX_SMTP_AUTH=', value: 'yes' }
#    - { field: 'POSTFIX_SMTP_AUTH_OPTIONS=', value: 'noanonymous' }
#    - { field: 'POSTFIX_SMTP_TLS_CLIENT=', value: 'must' }
##    - { field: 'POSTFIX_SMTP_TLS_SERVER=', value: 'yes' } # needed to activate TLS engine
##    - { field: 'POSTFIX_TLS_CAFILE=', value: '/etc/ssl/certs/GlobalSign_Root_CA_-_R2.pem' }
#    - { field: 'POSTFIX_TLS_CAFILE=', value: '/etc/ssl/ca-bundle.pem' }
#    - { field: 'POSTFIX_TLS_CERTFILE=', value: '' }
#    - { field: 'POSTFIX_TLS_KEYFILE=', value: '' }

#    - { field: 'POSTFIX_MYHOSTNAME=', value: '{{server_name}}' }
#    - { field: 'POSTFIX_LOCALDOMAINS=', value: '{{server_name}}, {{server_domain}}, localhost' }
#  register: config_status
#  notify: "restart postfix"
#  when: ansible_distribution == 'openSUSE Leap'

#- name: check postfix is running
#  systemd:
#    name: postfix
#    state: started
#  when: ansible_distribution == 'openSUSE Leap' and config_status.changed

#- name: refresh postfix
#  command: "/usr/sbin/config.postfix"
#  when: ansible_distribution == 'openSUSE Leap' and config_status.changed
#  notify: "restart postfix"
  
# https://www.howtoforge.com/tutorial/configure-postfix-to-use-gmail-as-a-mail-relay/

- name: set main.cf config
  lineinfile:
    path: /etc/postfix/main.cf
    regexp: '^{{item.field}}'
    line: '{{item.field}} = {{item.value}}'
  with_items:
    - { os: "",               field: 'inet_protocols', value: 'all' }                                                      # POSTFIX_INET_PROTO = all
    - { os: "",               field: 'relayhost', value: '[smtp.gmail.com]:587' }                                          # POSTFIX_RELAYHOST

    - { os: "",               field: 'smtp_sasl_auth_enable', value: 'yes' }                                               # POSTFIX_SMTP_AUTH = yes
    - { os: "",               field: 'smtp_sasl_password_maps', value: 'hash:/etc/postfix/sasl_passwd' }                   # POSTFIX_SMTP_AUTH = yes
    - { os: "",               field: 'smtp_sasl_security_options', value: 'noanonymous' }                                  # POSTFIX_SMTP_AUTH = yes && POSTFIX_SMTP_AUTH_OPTIONS

    - { os: "",               field: 'smtp_use_tls', value: 'yes' }                                                        # POSTFIX_SMTP_TLS_CLIENT = yes
    - { os: "",               field: 'smtp_enforce_tls', value: 'yes' }                                                    # POSTFIX_SMTP_TLS_CLIENT = yes
    - { os: "Fedora",         field: 'smtp_tls_CAfile', value: '/etc/ssl/certs/ca-bundle.crt' }                            # POSTFIX_SMTP_TLS_CLIENT = yes && POSTFIX_TLS_CAFILE
    - { os: "openSUSE Leap",  field: 'smtp_tls_CAfile', value: '/etc/ssl/ca-bundle.pem' }

    - { os: "",               field: 'mydestination', value: '{{server_name}}, {{server_domain}}, localhost' }             # POSTFIX_LOCALDOMAINS
    - { os: "",               field: 'myhostname', value: '{{server_name}}' }                                              # POSTFIX_MYHOSTNAME
  when: item.os == "" or item.os == ansible_distribution
  register: config_changed
  notify: "restart postfix"

- name: disable sysconfig based configuration on suse
  shell: "if [ -f /etc/sysconfig/postfix ]; then mv /etc/sysconfig/postfix /etc/sysconfig/postfix.org; fi"
  when: ansible_distribution == 'openSUSE Leap'

- name: set master.cf config on suse
  lineinfile:
    path: /etc/postfix/master.cf
    regexp: '^tlsmgr'
    line: 'tlsmgr    unix  -       -       n       1000?   1       tlsmgr'
  notify: "restart postfix"
  when: ansible_distribution == 'openSUSE Leap'

- name: set sasl_passwd
  lineinfile:
    path: /etc/postfix/sasl_passwd
    regexp: '^\[smtp.gmail.com\]:587'
    line: '[smtp.gmail.com]:587 {{ root_mail_account }}:{{ root_mail_password }}'
    create: true # needed for fedora
    owner: root
    group: root
    mode: 0600
  register: password_changed
  notify: "restart postfix"
  when: "vault_active|bool"
  
- name: rebuild sasl_passwd.db
  shell: "if [ -f /etc/postfix/{{item}} ]; then postmap /etc/postfix/{{item}}; fi"
  with_items:
    - generic
    - sasl_passwd
    - relay
  when: config_changed.changed or password_changed.changed
  
#mkfifo /var/spool/postfix/public/pickup
  
- name: set aliases
  lineinfile:
    path: /etc/aliases
    regexp: '^{{item.name}}'
    line: '{{item.name}}: {{item.alias}}'
  with_items:
    - { name: 'root', alias: '{{ admin_mail }}' }
    - { name: 'postmaster', alias: '{{ admin_mail }}' }
    - { name: 'default', alias: '{{ admin_mail }}' }
  register: aliases_status
  notify: "restart postfix"
  when: "vault_active|bool"

- name: refresh aliases
  command: "/usr/bin/newaliases"
  when: aliases_status.changed
  notify: "restart postfix"
