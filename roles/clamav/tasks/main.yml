- name: install required fedora packages
  yum:
    name: [
      clamav
      , clamav-update
      , clamav-server 
      , clamav-server-systemd 
      , clamav-scanner
    ]
    state: present
  register: fedora_install_status
  notify: "restart clamav"
  when: is_fedora|bool

- name: add zypper repository on suse
  zypper_repository:
    name: Security (clamav)
    repo: "http://download.opensuse.org/repositories/security/openSUSE_Leap_{{ansible_distribution_version}}/"
    auto_import_keys: yes
    priority: "100"
    state: present
  when: is_suse|bool

- name: install required suse packages
  zypper:
    name: clamav>=0.101.3
    state: present
  register: suse_install_status
  notify: "restart clamav"
  when: is_suse|bool

- name: disable config
  lineinfile:
    path: "/etc/{{ 'clamd.conf' if is_suse|bool else 'clamd.d/scan.conf' }}"
    regexp: '^{{item.regexp}}'
    line: '{{item.line}}'
    backrefs: yes
  with_items:
    - { regexp: "(Example.*)", line: "#\\1" }
    - { regexp: "(TCPSocket.*)", line: "#\\1" }
    - { regexp: "(TCPAddr.*)", line: "#\\1" }
  notify: "restart apache"

- name: set config
  lineinfile:
    path: "/etc/{{ 'clamd.conf' if is_suse|bool else 'clamd.d/scan.conf' }}"
    regexp: '^{{item.regexp}}'
    line: '{{item.line}}'
  with_items:
    - { regexp: "LogFacility .*", line: "LogFacility LOG_MAIL" }
    - { regexp: "PidFile .*", line: "PidFile {{ '/var/run/clamav/clamd.pid' if is_suse else '/run/clamd.scan/clamd.pid'  }}" }
    - { regexp: "LocalSocket .*", line: "LocalSocket {{ '/var/run/clamav/clamd-socket' if is_suse else '/run/clamd.scan/clamd.sock'  }}" }

- name: load initial database
  shell: '/usr/bin/freshclam --no-warnings'
  notify: "restart clamav"
  when: suse_install_status.changed or fedora_install_status.changed

- name: change clamd startup timeout
  lineinfile:
    path: "/usr/lib/systemd/system/{{ 'clamd.service' if is_suse|bool else 'clamd@.service' }}"
    insertafter: '^\[Service\]'
    regexp: '^TimeoutSec\s*='
    line: 'TimeoutSec=5min'
  notify: "restart clamav"

#- name: create cron job
#  vars:
#    name: "ClamAV file check"
#    cmd: "clamscan -r -i {{nextcloud_data_path}}"
#    file: "ansible_clamav_check"
#    hour: "3"
#    minute: "0"
#  import_tasks: roles/cron/tasks/add_cronjob.yml
#  when: "is_production|bool"
