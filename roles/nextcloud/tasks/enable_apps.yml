- name: set version
  set_fact:
    nextcloud_news_version: '16.2.1'
    nextcloud_keeweb_version: '0.6.6'
  
# ***** CHECK *****
- name: check mysql service
  import_tasks: roles/mysql/tasks/wait_until_ready.yml
    
- name: check redis service
  import_tasks: roles/redis/tasks/wait_until_ready.yml

- name: check apache service
  import_tasks: roles/apache/tasks/wait_until_ready.yml

# ***** DISABLE APPS *****
- name: disable apps
  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ app:disable {{item}}\""
  register: command_result
  changed_when: "'disabled' in command_result.stdout"
#  failed_when: "'disabled' not in command_result.stdout and 'such app enabled' not in command_result.stdout"
  with_items:
    - dashboard

# ***** INSTALL APPS *****
- name: install apps
  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ app:install {{item}}\""
  register: command_result
  failed_when: "'installed' not in command_result.stdout and 'enabled' not in command_result.stdout and 'already exists' not in command_result.stdout"
  changed_when: "'enabled' in command_result.stdout"
  with_items:
    - user_saml # must always be the first one
    - onlyoffice # must always be the second one
    - jsloader # must always be the third one
    - bookmarks
    - contacts
    - calendar
    - notes
    - tasks
    
# ***** CONFIGURE user_saml *****
- name: enable environment based authentication through user_saml app
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 nextcloud -e \\\"INSERT INTO oc_appconfig (appid, configkey, configvalue) VALUES ('user_saml', '{{item.name}}', '{{item.value}}') ON DUPLICATE KEY UPDATE configvalue='{{item.value}}';\\\"\""
  with_items:
    - { name: "type", value: "environment-variable" }
    - { name: "general-uid_mapping", value: "REMOTE_USERNAME" }
  when: "command_result.results[0].changed" # index 0 is app 'user_saml'

# ***** CONFIGURE onlyoffice *****
- name: set onlyoffice configuration
#  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ --no-warnings config:system:set onlyoffice {{item.name}} --value=\\\"{{item.value}}\\\"\""
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 nextcloud -e \\\"INSERT INTO oc_appconfig (appid, configkey, configvalue) VALUES ('onlyoffice', '{{item.name}}', '{{item.value}}') ON DUPLICATE KEY UPDATE configvalue='{{item.value}}';\\\"\""
  with_items:
    - { name: "DocumentServerInternalUrl", value: "" }
    - { name: "DocumentServerUrl", value: "https://onlyoffice.{{server_domain}}/" }
    - { name: "StorageUrl", value: "" }
    - { name: "customizationChat", value: "false" }
    - { name: "customizationCompactHeader", value: "true" }
    - { name: "customizationForcesave", value: "true" }
    - { name: "customizationFeedback", value: "false" }
    - { name: "customizationHelp", value: "true" }
    - { name: "customizationReviewDisplay", value: "original" }
    - { name: "customizationToolbarNoTabs", value: "true" }
    - { name: "defFormats", value: '{\\\"csv\\\":\\\"true\\\",\\\"doc\\\":\\\"true\\\",\\\"docm\\\":\\\"false\\\",\\\"docx\\\":\\\"true\\\",\\\"dotx\\\":\\\"true\\\",\\\"epub\\\":\\\"false\\\",\\\"html\\\":\\\"false\\\",\\\"odp\\\":\\\"true\\\",\\\"ods\\\":\\\"true\\\",\\\"odt\\\":\\\"true\\\",\\\"pdf\\\":\\\"false\\\",\\\"potm\\\":\\\"false\\\",\\\"potx\\\":\\\"false\\\",\\\"ppsm\\\":\\\"false\\\",\\\"ppsx\\\":\\\"true\\\",\\\"ppt\\\":\\\"false\\\",\\\"pptm\\\":\\\"false\\\",\\\"pptx\\\":\\\"false\\\",\\\"rtf\\\":\\\"true\\\",\\\"txt\\\":\\\"true\\\",\\\"xls\\\":\\\"true\\\",\\\"xlsm\\\":\\\"false\\\",\\\"xlsx\\\":\\\"true\\\",\\\"xltm\\\":\\\"false\\\",\\\"xltx\\\":\\\"false\\\"}' }
    - { name: "editFormats", value: '{\\\"csv\\\":\\\"true\\\",\\\"odp\\\":\\\"false\\\",\\\"ods\\\":\\\"false\\\",\\\"odt\\\":\\\"false\\\",\\\"rtf\\\":\\\"false\\\",\\\"txt\\\":\\\"true\\\"}' }
    - { name: "enabled", value: "yes" }
    - { name: "groups", value: "[]" }
    - { name: "preview", value: "false" }
    - { name: "sameTab", value: "false" }
    - { name: "settings_error", value: "" }
    - { name: "types", value: "filesystem" }
    - { name: "verify_peer_off", value: "false" }
    - { name: "versionHistory", value: "true" }
  when: "command_result.results[1].changed"

- name: set onlyoffice shared key # must be separate to avoid visibile shared key in console log
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 nextcloud -e \\\"INSERT INTO oc_appconfig (appid, configkey, configvalue) VALUES ('onlyoffice', 'jwt_secret', '{{vault_onlyoffice_shared_key}}') ON DUPLICATE KEY UPDATE configvalue='{{vault_onlyoffice_shared_key}}';\\\"\""
  when: "command_result.results[1].changed"

# ***** CONFIGURE jsloader *****
- name: set jsloader
  shell: "docker exec mysql sh -c \"mysql -u root -h 127.0.0.1 nextcloud -e \\\"INSERT INTO oc_appconfig (appid, configkey, configvalue) VALUES ('jsloader', 'snippet', 'document.domain=\\'{{server_domain}}\\'; var script = document.createElement(\\'script\\'); script.src = \\'https://\\' + document.domain + \\'/main/listener/frame.js\\'; document.head.appendChild(script);') ON DUPLICATE KEY UPDATE configvalue='document.domain=\\'{{server_domain}}\\'; var script = document.createElement(\\'script\\'); script.src = \\'https://\\' + document.domain + \\'/main/listener/frame.js\\'; document.head.appendChild(script);';\\\"\""
  when: "command_result.results[2].changed"
  
# ***** INSTALL KEEWEB *****
- name: check for outdated keeweb version
  shell: "grep --invert \"<version>{{nextcloud_keeweb_version}}<\\/version>\" {{htdocs_path}}nextcloud/apps/keeweb/appinfo/info.xml | grep \"<version>.*<\\/version>\""
  register: keeweb_result
  changed_when: "keeweb_result.rc == 0"
  failed_when: False
  
- name: uninstall outdated keeweb version => old version was detected
  file:
    state: absent
    path: "{{htdocs_path}}nextcloud/apps/keeweb/"
  when: "keeweb_result.rc == 0"
  
- name: install keeweb app => app does not exists
  unarchive:
    src: "https://github.com/jhass/nextcloud-keeweb/releases/download/v{{nextcloud_keeweb_version}}/keeweb-{{nextcloud_keeweb_version}}.tar.gz"
    dest: "{{htdocs_path}}nextcloud/apps/"
    remote_src: yes
    creates: "{{htdocs_path}}nextcloud/apps/keeweb/"
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
  register: keeweb_installation
  
- name: copy patched service-worker.js
  template:
    src: "templates/apps/service-worker.js"
    dest: "{{htdocs_path}}nextcloud/apps/keeweb/templates/service-worker.js"
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
    mode: 0644
#  when: keeweb_installation.changed

#- name: check keeweb max version
#  lineinfile:
#    path: "{{htdocs_path}}nextcloud/apps/keeweb/appinfo/info.xml"
#    regexp: '(.*max-version)="[0-9]+"(.*)'
#    line: '\1="21"\2'
#    backrefs: yes
#  when: keeweb_installation.changed
  
# ***** INSTALL NEWS *****
- name: check for outdated news version
  shell: "grep --invert \"<version>{{nextcloud_news_version}}<\\/version>\" {{htdocs_path}}nextcloud/apps/news/appinfo/info.xml | grep \"<version>.*<\\/version>\""
  register: news_result
  changed_when: "news_result.rc == 0"
  failed_when: False
  
- name: uninstall outdated news version => old version was detected
  file:
    state: absent
    path: "{{htdocs_path}}nextcloud/apps/news/"
  when: "news_result.rc == 0"

- name: install news app
  unarchive:
    src: "https://github.com/nextcloud/news/releases/download/{{nextcloud_news_version}}/news.tar.gz"
    dest: "{{htdocs_path}}nextcloud/apps/"
    remote_src: yes
    creates: "{{htdocs_path}}nextcloud/apps/news/"
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
  register: news_installation
  
#- name: patch news app min required version => app installation changed
#  lineinfile:
#    path: "{{htdocs_path}}nextcloud/apps/news/appinfo/info.xml"
#    regexp: '<nextcloud min-version='
#    line: '<nextcloud min-version="14" max-version="20"/>'
#  when: news_installation.changed
  
- name: prepare news config folder
  file:
    path: "{{item}}"
    state: directory
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
    mode: 0750
  with_items:
    - "{{nextcloud_data_path}}news"
    - "{{nextcloud_data_path}}news/config"
    
- name: copy news config
  template:
    src: "templates/apps/news.ini"
    dest: "{{nextcloud_data_path}}news/config/config.ini"
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
    mode: 0640

# maybe cleanup 
# UPDATE `oc_jobs` SET `reserved_at` = 0 WHERE `class` = 'OCA\\News\\Cron\\Updater'
    
# ***** UPGRADE AFTER keeweb or news installatioin *****
- name: upgrade existing database => keeweb or news version changed
  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ upgrade\""
  when: "keeweb_installation.changed or news_installation.changed"
  
# ***** ENABLE ADDITIONAL APPS *****
- name: get app status
  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ app:list\""
  register: app_status
  changed_when: no

- name: enable keeweb and news apps
  shell: "docker exec php sh -c \"php {{htdocs_path}}nextcloud/occ app:enable {{item}} --force\""
  register: command_result
  failed_when: "'enabled' not in command_result.stdout"
  when: "item not in app_status.stdout.split('Disabled')[0]"
  with_items:
    - keeweb
    - news

- name: register news update notifier
  vars:
    name: "nextcloud_news"
    type: "github"
    url: "https://github.com/nextcloud/news/releases"
    config: { 
      project: "nextcloud/news", 
      pattern: "^([0-9\\.]+)$",
      version: "{{nextcloud_news_version}}" 
    }
  import_tasks: roles/update_notifier/tasks/add_notifier.yml

- name: register keeweb update notifier
  vars:
    name: "nextcloud_keeweb"
    type: "github"
    url: "https://github.com/jhass/nextcloud-keeweb/releases"
    config: { 
      project: "jhass/nextcloud-keeweb", 
      pattern: "^v([0-9\\.]+)$",
      version: "v{{nextcloud_keeweb_version}}" 
    }
  import_tasks: roles/update_notifier/tasks/add_notifier.yml
