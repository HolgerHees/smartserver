- name: prepare needed folder
  file:
    path: "{{item.dir}}"
    state: directory
    owner: "{{item.owner}}"
    group: "{{item.group}}"
    mode: 0755
  with_items:
    - { owner: "{{www_username}}", group: "{{www_group}}", dir: "{{htdocs_path}}main/" }
    - { owner: "{{www_username}}", group: "{{www_group}}", dir: "{{htdocs_path}}img/" }
    - { owner: "{{www_username}}", group: "{{www_group}}", dir: "{{htdocs_path}}img/potd" }
    - { owner: root, group: root, dir: "/opt/potd_fetcher/" }

- name: copy htdocs
  copy:
    src: "templates/htdocs/{{item}}"
    dest: "{{htdocs_path}}{{item|dirname}}"
    owner: "{{www_username}}"
    group: "{{www_group}}"
  with_items:
    - main/css
    - main/img
    - main/js
    - favicon.ico
    - index.de.json
    - info.php
    - resize.php
  
- name: copy htdocs (template)
  template:
    src: "templates/htdocs/{{item}}"
    dest: "{{htdocs_path}}/{{item}}"
  with_items:
    - index.php
    - main/manifest.json

- name: copy mainfest config
  template:
    src: "templates/etc/apache2/_.ansible.d/manifest.conf"
    dest: "{{www_etc}}_.ansible.d/manifest.conf"
    owner: root
    group: root
    mode: 0644
  notify: "restart apache"

- name: copy fetchPOTD cmd
  template:
    src: "templates/fetchPOTD.sh"
    dest: "/opt/potd_fetcher/fetchPOTD.sh"
    owner: root
    group: root
    mode: 0750

- name: check potd file
  stat:
    path: "{{htdocs_path}}img/potd/todayTitle.txt"
  register: potd_exists
  changed_when: not potd_exists.stat.exists
  
- name: fetch initial potd => initial image does not exist
  shell: '/opt/potd_fetcher/fetchPOTD.sh'
  when: not potd_exists.stat.exists
  
# Picture of the day fetcher
- name: create cron job
  vars:
    name: "POTD Fetcher"
    cmd: "/opt/potd_fetcher/fetchPOTD.sh"
    file: "ansible_apache_webui"
    hour: "3"
    minute: "0"
  import_tasks: roles/cron/tasks/add_cronjob.yml
