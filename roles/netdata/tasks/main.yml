- name: add zypper repository
  zypper_repository:
    name: Network (netdata)
    repo: http://download.opensuse.org/repositories/network/openSUSE_Leap_15.0/
    auto_import_keys: yes
    priority: 100
    state: present
    
- name: install required packages
  zypper:
    name: [
        netdata>=1.14
      , fping
    ]
    state: present
  notify: "restart netdata"
  
- name: prepare needed folder
  file:
    path: '{{ item }}'
    state: directory
    owner: netdata
    group: netdata
    mode: 0750
    #recurse: true
  with_items:
    - "{{ global_lib }}netdata"
    - "{{ global_lib }}netdata/cache"
  
- name: copy config
  template:
    src: "roles/netdata/templates{{item}}"
    dest: "{{item}}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - /etc/netdata/netdata.conf
    - /etc/netdata/python.d.conf
    - /etc/netdata/fping.conf
    - /etc/netdata/health.d/disks.conf
    - /etc/netdata/health.d/softnet.conf
    - /etc/netdata/health.d/net.conf
    - /etc/netdata/health.d/fping.conf
  notify: "restart netdata"
  
- name: change runtime user
  lineinfile:
    path: /usr/lib/systemd/system/netdata.service
    regexp: '^User='
    line: 'User=root'
  notify: "restart netdata"

- name: copy apache config
  template:
    src: "roles/netdata/templates/etc/apache2/_.ansible.d/netdata.conf"
    dest: "/etc/apache2/_.ansible.d/netdata.conf"
    owner: root
    group: root
    mode: 0640
  notify: "restart apache"
  tags: ['apache_conf']
  
