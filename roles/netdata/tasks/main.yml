- name: add zypper repository
  zypper_repository:
    name: Network (netdata)
    repo: http://download.opensuse.org/repositories/network/openSUSE_Leap_15.0/
    auto_import_keys: yes
    priority: 100
    state: present
    
- name: install required packages
  zypper:
    name: [
        netdata>=1.14
      , fping
    ]
    state: present
  notify: "restart netdata"
  
- name: prepare needed folder
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0750
    #recurse: true
  with_items:
    - "{{ global_lib }}netdata"
    - "{{ global_lib }}netdata/cache"
    - "/etc/netdata/custom-plugins.d"
    - "/opt/netdata_helper"
  
- name: copy config
  template:
    src: "roles/netdata/templates{{item.path}}"
    dest: "{{item.path}}"
    owner: root
    group: root
    mode: "{{item.mode}}"
  with_items:
    - { mode: "u=rwx,g=rx,o=", path: "/opt/netdata_helper/send_notification.sh" }
    - { mode: "u=rwx,g=rx,o=", path: "/opt/netdata_helper/inform_openhab.php" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/netdata.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/python.d.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/health_alarm_notify.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/fping.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/health.d/disks.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/health.d/softnet.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/health.d/net.conf" }
    - { mode: "u=rw,g=r,o=", path: "/etc/netdata/health.d/fping.conf" }
  notify: "restart netdata"
  
- name: change runtime user
  lineinfile:
    path: /usr/lib/systemd/system/netdata.service
    regexp: '^User='
    line: 'User=root'
  notify: "restart netdata"

- name: copy apache config
  template:
    src: "roles/netdata/templates/etc/apache2/_.ansible.d/netdata.conf"
    dest: "/etc/apache2/_.ansible.d/netdata.conf"
    owner: root
    group: root
    mode: 0640
  notify: "restart apache"
  tags: ['apache_conf']
  
- name: set cron job
  vars:
    cron_name: "Netdata error check"
    cron_cmd: "/usr/bin/php -f /opt/netdata_helper/inform_openhab.php;"
  cron:
    name: "{{cron_name}}"
    job: "{{ lookup('template', 'templates/cron_job') }}"
    cron_file: ansible_cron_service_check
    user: root
    state: present
  when: is_production
  tags: ['cron_job']
