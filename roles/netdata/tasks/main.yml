- name: add zypper repository
  zypper_repository:
    name: Network (netdata)
    repo: "http://download.opensuse.org/repositories/network/openSUSE_Leap_{{ansible_distribution_version}}/"
    auto_import_keys: yes
    priority: "100"
    state: present
    
- name: install required packages
  zypper:
    name: [
        netdata>=1.18
      , fping
      # needed to rebuild rpm package
      #, rpm-build
      #, cups-devel
      #, judy-devel
      #, libcap-devel
      #, liblz4-devel
      #, libmnl-devel
      #, libnetfilter_acct-devel
      #, libuv-devel
      #, freeipmi-devel
    ]
    state: present
  notify: "restart netdata"
  
- name: prepare needed folder
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0750
    #recurse: true
  with_items:
    - "{{ global_lib }}netdata"
    - "{{ global_lib }}netdata/cache"
    - "/etc/netdata/custom-plugins.d"
    - "/opt/netdata_helper"
  
- name: copy config
  template:
    src: "roles/netdata/templates{{item}}"
    dest: "{{item}}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - "/etc/netdata/netdata.conf"
    - "/etc/netdata/python.d.conf"
    - "/etc/netdata/health_alarm_notify.conf"
    - "/etc/netdata/fping.conf"
    - "/etc/netdata/.environment"
    - "/etc/netdata/health.d/disks.conf"
    - "/etc/netdata/health.d/softnet.conf"
    - "/etc/netdata/health.d/net.conf"
    - "/etc/netdata/health.d/fping.conf"
  notify: "restart netdata"
  
- name: copy helper
  template:
    src: "roles/netdata/templates{{item}}"
    dest: "{{item}}"
    owner: root
    group: root
    mode: 0750
  with_items:
    - "/opt/netdata_helper/send_notification.sh"
    - "/opt/netdata_helper/inform_openhab.php"

- name: change runtime user
  lineinfile:
    path: /usr/lib/systemd/system/netdata.service
    regexp: '{{item.regex}}'
    line: '{{item.line}}'
  with_items:
    - { regex: "^User=", line: "User=root" }
    #- { regex: "^CPUSchedulingPolicy=", line: "CPUSchedulingPolicy=other" } # was "idle" before
    #- { regex: "^[#]+Nice=", line: "Nice=0" } # was "#Nice=0" before
  notify: "restart netdata"

- name: copy apache config
  template:
    src: "roles/netdata/templates/etc/apache2/_.ansible.d/netdata.conf"
    dest: "/etc/apache2/_.ansible.d/netdata.conf"
    owner: root
    group: root
    mode: 0640
  notify: "restart apache"
  tags: ['apache_conf']
  
- name: set cron job
  vars:
    cron_name: "Netdata error check"
    cron_cmd: "/usr/bin/php -f /opt/netdata_helper/inform_openhab.php"
  cron:
    name: "{{cron_name}}"
    job: "{{ lookup('template', 'templates/cron_job') }}"
    cron_file: ansible_netdata
    user: root
    state: present
  when: "is_production|bool"
  tags: ['cron_job']
