- name: install required fedora packages
  yum:
    name: [
        netdata
      , fping
    ]
    state: present
  notify: "restart netdata"
  when: ansible_distribution == 'Fedora'

- name: add zypper repository
  zypper_repository:
    name: Network (netdata)
    repo: "http://download.opensuse.org/repositories/network/openSUSE_Leap_{{ansible_distribution_version}}/"
    auto_import_keys: yes
    priority: "100"
    state: present
  when: ansible_distribution == 'openSUSE Leap'
    
- name: install required suse packages
  zypper:
    name: [
        netdata
      , fping
      # needed to rebuild rpm package
      #, rpm-build
      #, cups-devel
      #, judy-devel
      #, libcap-devel
      #, liblz4-devel
      #, libmnl-devel
      #, libnetfilter_acct-devel
      #, libuv-devel
      #, freeipmi-devel
    ]
    state: present
  notify: "restart netdata"
  when: ansible_distribution == 'openSUSE Leap'
  
- name: prepare needed folder
  file:
    path: '{{ item }}'
    state: directory
    owner: root
    group: root
    mode: 0750
    #recurse: true
  with_items:
    - "{{ global_lib }}netdata"
    - "{{ global_lib }}netdata/cache"
    #- "/etc/netdata/custom-plugins.d"
    - "/etc/netdata/health.d"
    - "/opt/netdata_helper"
  
- name: copy config
  template:
    src: "roles/netdata/templates{{item}}"
    dest: "{{item}}"
    owner: root
    group: root
    mode: 0640
  with_items:
    - "/etc/netdata/netdata.conf"
    - "/etc/netdata/python.d.conf"
    - "/etc/netdata/health_alarm_notify.conf"
    - "/etc/netdata/fping.conf"
    - "/etc/netdata/.environment"
    - "/etc/netdata/health.d/disks.conf"
    - "/etc/netdata/health.d/softnet.conf"
    - "/etc/netdata/health.d/net.conf"
    - "/etc/netdata/health.d/fping.conf"
  notify: "restart netdata"
  
- name: copy helper
  template:
    src: "roles/netdata/templates{{item}}"
    dest: "{{item}}"
    owner: root
    group: root
    mode: 0750
  with_items:
    - "/opt/netdata_helper/send_notification.sh"
    - "/opt/netdata_helper/inform_openhab.php"

- name: change runtime user
  lineinfile:
    path: /usr/lib/systemd/system/netdata.service
    regexp: '^[#]*{{item.field}}\s*='
    line: '{{item.field}}={{item.value}}'
  with_items:
    - { field: "User", value: "root" }
    #- { field: "CPUSchedulingPolicy", value: "other" } # was "idle" before
    #- { field: "Nice", value: "0" } # was "#Nice=0" before
  notify: "restart netdata"

- name: copy apache config
  vars:
    config_file: "roles/netdata/templates/etc/apache2/_.ansible.d/netdata.conf"
  include_role:
    name: apache
    tasks_from: add_config
  tags: ['apache_conf']
  
- name: create cron job
  vars:
    name: "Netdata error check"
    cmd: "/usr/bin/php -f /opt/netdata_helper/inform_openhab.php"
    file: "ansible_netdata"
  include_role:
    name: cron
    tasks_from: add_cronjob
  tags: ['cron_job']
