- name: ensure user and group exists
  vars:
    user: { name: "ftp", system: true, home: "{{ftp_path}}" }
    group: { name: "ftp", system: true }
  import_tasks: roles/user/shared/add_system_user.yml

- name: prepare ftp camera upload folder
  file:
    path: "{{ftp_path}}/{{item['ftp_upload_name']}}"
    state: directory
    owner: "{{system_users['ftp'].name}}"
    group: "{{system_groups['ftp'].name}}"
    mode: 0755
  when: "'ftp_upload_name' in item"
  with_items: "{{camera_devices}}"

- name: synchronize htdocs
  synchronize:
    src: "templates/htdocs/"
    dest: "{{htdocs_path}}"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown={{system_users['www'].name}}:{{system_groups['www'].name}}"
      - "--chmod=D755,F644"
  
- name: copy htdocs (template)
  template:
    src: "templates/htdocs_templates/{{item}}"
    dest: "{{htdocs_path}}/{{item}}"
    owner: "{{system_users['www'].name}}"
    group: "{{system_groups['www'].name}}"
    mode: "u=rwX,g=rX,o="
  with_items:
    - gallery/config.php

- name: copy proxy config
  vars:
    config_file: "templates/etc/apache2/_.ansible.d/cameras.conf"
  import_tasks: roles/apache/shared/add_config.yml

- name: register webui
  vars:
    name: "cameras"
    js_file: "templates/webui/cameras.js"
    i18n_files: [ { language: "de", file: "templates/webui/cameras.de.json" } ]
    icons: []
  import_tasks: roles/apache_webui/shared/add_webui.yml

# ***** FINALIZE *****
- name: create cleanup cron job
  vars:
    name: "Gallery Cleanup"
    cmd: "docker exec php sh -c \"php -f {{htdocs_path}}gallery/cron/preview_generator.php clean\""
    file: "ansible_gallery"
    hour: "0"
    minute: "50"
  import_tasks: roles/cron/shared/add_cronjob.yml

- name: create full preview cron job
  vars:
    name: "Gallery Full Previews"
    cmd: "/usr/bin/flock -n {{global_tmp}}gallery.lock timeout 30m docker exec php sh -c \"php -f {{htdocs_path}}gallery/cron/preview_generator.php generate full > /dev/null\""
    file: "ansible_gallery"
    hour: "1"
    minute: "0"
  import_tasks: roles/cron/shared/add_cronjob.yml

- name: create partial preview cron job
  vars:
    name: "Gallery Partial Previews"
    cmd: "docker exec php sh -c \"php -f {{htdocs_path}}gallery/cron/preview_generator.php generate partial > /dev/null\""
    file: "ansible_gallery"
    hour: "*"
    minute: "*"
  import_tasks: roles/cron/shared/add_cronjob.yml
