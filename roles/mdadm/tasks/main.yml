- name: install required fedora packages
  yum:
    name: "mdadm"
    state: present
  notify: "restart mdmonitor"
  when: ansible_distribution == 'Fedora'
  
- name: install required suse packages
  zypper:
    name: "mdadm"
    state: present
  notify: "restart mdmonitor"
  when: ansible_distribution == 'openSUSE Leap'
  
- name: set config
  lineinfile:
    path: /etc/sysconfig/{{ 'mdadm' if ansible_distribution == 'openSUSE Leap' else 'mdmonitor' }}
    regexp: '^{{item.field}}'
    line: '{{item.field}}="{{item.value}}"'
    create: true
    owner: root
    group: root
    mode: 0640
  with_items:
    - { field: 'MDADM_DELAY=', value: '60' }
    - { field: 'MDADM_MAIL=', value: 'root' }
    - { field: 'MDADM_RAIDDEVICES=', value: '/dev/md0' }
    - { field: 'MDADM_SCAN=', value: 'yes' }
    - { field: 'MDADM_SEND_MAIL_ON_START=', value: 'yes' }
    - { field: 'MDADM_DEVICE_TIMEOUT=', value: '60' }
  notify: "restart mdmonitor"

- name: disable default check cron jobs
  file: 
    path: '/etc/cron.d/mdadm'
    state: absent

- name: set cron job env
  cron:
    name: PATH
    env: yes
    value: /sbin:/usr/sbin:/bin:/usr/bin
    cron_file: ansible_mdadm
    user: root
  tags: cron
    
- name: create check (start) cron job
  vars:
    cron_name: "RAID Check (Start)"
    cron_cmd: "/usr/share/mdadm/mdcheck --duration 4 hours"
  cron:
    name: "{{cron_name}}"
    job: "{{ lookup('template', 'templates/cron_job') }}"
    cron_file: ansible_mdadm
    user: root
    minute: "0"
    hour: "1"
    weekday: "7"
    state: present
  tags: ['cron_job']
  
- name: create check (continue) cron job
  vars:
    cron_name: "RAID Check (Continue)"
    cron_cmd: "/usr/share/mdadm/mdcheck --continue --duration 4 hours"
  cron:
    name: "{{cron_name}}"
    job: "{{ lookup('template', 'templates/cron_job') }}"
    cron_file: ansible_mdadm
    user: root
    minute: "0"
    hour: "1"
    weekday: "1-6"
    state: present
  tags: ['cron_job']
  
