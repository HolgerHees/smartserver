- name: check elasticsearch service
  import_tasks: roles/elasticsearch/tasks/wait_until_ready.yml

- name: check kibana service => kibana status changed
  import_tasks: roles/kibana/tasks/wait_until_ready.yml

- name: prepare build folder
  file:
    path: "{{global_build}}fluentd/"
    state: directory
    owner: root
    group: root
    mode: 0750

- name: copy policies
  copy:
    src: "roles/fluentd/templates/policy/{{item}}"
    dest: "{{global_build}}fluentd/{{item}}"
    owner: root
    group: root
  register: policy_result
  with_items:
    - create_policy.json
    - assign_policy.json

#curl -XPUT -H 'Content-Type: application/json' http://localhost:9200/_template/filebeat-7.7.1 -d@filebeat.template.json
    
- name: "Clean policy"
  shell: "curl -X DELETE \"http://localhost:5601/api/ism/policies/fluentd_policy?\" -H \"kbn-xsrf: true\""
  failed_when: "'\"ok\":true' not in delete_result.stdout"
  register: delete_result
  args:
    warn: false

#- name:
#  debug:
#    msg: "{{delete_result}}"

- name: "Create policy"
  shell: "curl -X PUT \"http://localhost:5601/api/ism/policies/fluentd_policy?\" -H \"kbn-xsrf: true\" -T {{global_build}}fluentd/create_policy.json"
  failed_when: "'\"ok\":true' not in delete_result.stdout"
  register: create_result
  args:
    warn: false
#  when: policy_result.changed

#- name:
#  debug:
#    msg: "{{create_result}}"
    
#https://kibana.smartmarvin.de/api/ism/applyPolicy
#{"indices":["fluentd-2020-06-11"],"policyId":"fluentd_policy"}

- name: "Assign policy"
  shell: "curl -X PUT \"http://localhost:5601/_template/fluentd_index\" -H \"kbn-xsrf: true\" -T {{global_build}}fluentd/assign_policy.json"
  #failed_when: "'\"success\":true' not in import_result.stdout"
  # {"success":true,"successCount":4}
  register: update_result
  args:
    warn: false
#  when: policy_result.changed

- name:
  debug:
    msg: "{{update_result}}"
