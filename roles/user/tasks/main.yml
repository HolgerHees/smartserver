# **** HHEES (SSH, SMB, WEB) ****
- name: add user "{{vault_user1_username}}" with no login
  user:
    name: "{{vault_user1_username}}"
#    uid: 1001
    shell: /bin/false
    home: "/home/{{vault_user1_username}}/"
    #password: "{{ holger_linux_password | password_hash('sha512') }}"
    #update_password: on_create
    groups: users
    append: no

- name: prepare user "{{vault_user1_username}}" folder
  file:
    path: "/home/{{vault_user1_username}}/"
    state: directory
    owner: "{{vault_user1_username}}"
    group: users
    mode: 0750
  
- name: add user "{{vault_user1_username}}" to samba
  shell: "( (pdbedit -L | grep {{vault_user1_username}}) && echo 'skipped' ) || ( ( printf '{{ vault_user1_samba_password }}\n{{ vault_user1_samba_password }}\n' | smbpasswd -a {{vault_user1_username}} ) && echo 'created' )"
  register: command_result
  #failed_when: "'command-not-found' in command_result.stderr"
  changed_when: "'created' in command_result.stdout"
  notify: "restart samba"

- name: add htpasswd user "{{vault_user1_username}}" to apache
  htpasswd:
    path: "{{htdocs_path}}.htpasswd"
    name: "{{vault_user1_username}}"
    password: "{{vault_user1_web_password}}"

- name: add htdigest user "{{vault_user1_username}}" to apache
  vars:
    username: "{{vault_user1_username}}"
    password: "{{vault_user1_web_password}}"
    realm: "{{server_name|capitalize}}"
  lineinfile:
    path: "{{htdocs_path}}.htdigest"
    regexp: '^{{vault_user1_username}}:{{server_name}}'
    line: "{{ lookup('template', 'roles/user/templates/htdigest') }}"
  
# **** SANDRA (SSH, SMB, WEB) ****
- name: add user "{{vault_user2_username}}" with no login
  user:
    name: "{{vault_user2_username}}"
#    uid: 1006
    shell: /bin/false
    home: "/home/{{vault_user2_username}}/"
    groups: users
    append: no

- name: prepare user "{{vault_user2_username}}" folder
  file:
    path: "/home/{{vault_user2_username}}/"
    state: directory
    owner: "{{vault_user2_username}}"
    group: users
    mode: 0750

- name: add user "{{vault_user2_username}}" to samba
  shell: "( (pdbedit -L | grep {{vault_user2_username}}) && echo 'skipped' ) || ( ( printf '{{ vault_user2_samba_password }}\n{{ vault_user2_samba_password }}\n' | smbpasswd -a {{vault_user2_username}} ) && echo 'created' )"
  register: command_result
  #failed_when: "'command-not-found' in command_result.stderr"
  changed_when: "'created' in command_result.stdout"
  notify: "restart samba"

- name: add htpasswd user "{{vault_user2_username}}" to apache
  htpasswd:
    path: "{{htdocs_path}}.htpasswd"
    name: "{{vault_user2_username}}"
    password: "{{vault_user2_web_password}}"

- name: add htdigest user "{{vault_user2_username}}" to apache
  vars:
    username: "{{vault_user2_username}}"
    password: "{{vault_user2_web_password}}"
    realm: "{{server_name|capitalize}}"
  lineinfile:
    path: "{{htdocs_path}}.htdigest"
    regexp: '^{{vault_user2_username}}:{{server_name}}'
    line: "{{ lookup('template', 'roles/user/templates/htdigest') }}"
    
# **** APACHE USERS (WEB) ****
- name: add htpasswd user "{{vault_admin_username}}" to apache
  htpasswd:
    path: "{{htdocs_path}}.htpasswd"
    name: "{{vault_admin_username}}"
    password: "{{vault_admin_web_password}}"
  
- name: add htdigest user "{{vault_admin_username}}" to apache
  vars:
    username: "{{vault_admin_username}}"
    password: "{{vault_admin_web_password}}"
    realm: "{{server_name|capitalize}}"
  lineinfile:
    path: "{{htdocs_path}}.htdigest"
    regexp: '^{{vault_admin_username}}:{{server_name}}'
    line: "{{ lookup('template', 'roles/user/templates/htdigest') }}"

- name: add htpasswd user "{{vault_alexa_username}}" to apache
  htpasswd:
    path: "{{htdocs_path}}.htpasswd"
    name: "{{vault_alexa_username}}"
    password: "{{vault_alexa_web_password}}"

- name: add htdigest user "{{vault_alexa_username}}" to apache
  vars:
    username: "{{vault_alexa_username}}"
    password: "{{vault_alexa_web_password}}"
    realm: "{{server_name|capitalize}}"
  lineinfile:
    path: "{{htdocs_path}}.htdigest"
    regexp: '^{{vault_alexa_username}}:{{server_name}}'
    line: "{{ lookup('template', 'roles/user/templates/htdigest') }}"
  
- name: add apache user to groups
  lineinfile:
    path: "{{htdocs_path}}.htgroups"
    regexp: '^{{item.group}}[\s:]{1}'
    line: '{{item.group}}: {{item.user}}'
  with_items:
    - { group: 'USER', user: '{{vault_user1_username}} {{vault_user2_username}} {{vault_admin_username}}' }
