# **** (SSH, SMB, WEB) ****
- name: add user with no login
  user:
    name: "{{item}}"
#    uid: 1001
    shell: /bin/false
    home: "/home/{{item}}/"
    #password: "{{ item.password | password_hash('sha512') }}"
    #update_password: on_create
    groups: users
    append: no
  with_items: "{{vault_usernames}}"
  
- name: prepare user folder
  file:
    path: "/home/{{item}}/"
    state: directory
    owner: "{{item}}"
    group: users
    mode: 0750
  with_items: "{{vault_usernames}}"
    
- name: add user to samba
  shell: "((echo '{{vault_userdata[item].samba_password}}'; echo '{{vault_userdata[item].samba_password}}';) | smbpasswd -s -a {{item}}) && ((pdbedit -L | grep {{item}}) || echo 'created';)"
  register: command_result
  #failed_when: "'command-not-found' in command_result.stderr"
  changed_when: "'created' in command_result.stdout"
  with_items: "{{vault_usernames}}"
  #notify: "restart samba"
  
- name: add user to apache .htpasswd
  vars:
    username: "{{item}}"
    password: "{{vault_userdata[item].web_password}}"
    group: "USER"
  include_tasks: roles/user/tasks/add_web_user.yml
  with_items: "{{vault_usernames}}"

- name: add user name to .htdata
  lineinfile:
    path: "{{htdocs_path}}.htdata"
    regexp: '^{{item}}:{{vault_userdata[item].name}}'
    line: '{{item}}:{{vault_userdata[item].name}}:{{vault_userdata[item].webui}}'
  with_items: "{{vault_usernames}}"

