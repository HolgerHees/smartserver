- name: check if apache groups exists
  shell: "grep \"^{{group}}\" {{htdocs_path}}.htgroups"
  register: groups_check
  loop_control:
    loop_var: group
  failed_when: False
  changed_when: no
  with_items: "{{usergroups | default([])}}"

- name: create missing apache groups
  lineinfile:
    path: "{{htdocs_path}}.htgroups"
    regexp: '^{{group}}[\s:]{1}.*'
    line: '{{group}}:'
  loop_control:
    loop_var: group
  with_items: "{{groups_check.results | selectattr('rc', 'equalto', 1) | map(attribute='group') | list }}"

- name: add user "{{username}}" to apache .htpasswd
  htpasswd:
    path: "{{htdocs_path}}.htpasswd"
    name: "{{username}}"
    password: "{{password}}"
 
- name: add user "{{username}}" to apache groups
  lineinfile:
    path: "{{htdocs_path}}.htgroups"
    backrefs: yes
    regexp: '^({{group}}:(?!.*{{username}}).*)'
    line: '\1 {{username}}'
  loop_control:
    loop_var: group
  with_items: "{{usergroups | default([])}}"
