<VirtualHost *:443>
	ServerName {{sub_domain}}.{{server_domain}}
	
    SSLEngine On
    SSLCertificateFile /etc/certbot/live/{{server_domain}}/fullchain.pem
	SSLCertificateKeyFile /etc/certbot/live/{{server_domain}}/privkey.pem

    Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains; preload"

    OIDCProviderMetadataURL {{vault_openid_connect_url}}
    OIDCClientID {{vault_openid_connect_client_id}}
    OIDCClientSecret {{vault_openid_connect_client_secret}}

    # OIDCRedirectURI is a vanity URL that must point to a path protected by this module but must NOT point to any content
    OIDCRedirectURI https://{{sub_domain}}.{{server_domain}}/redirect_uri
    OIDCCryptoPassphrase {{vault_openid_connect_passphrase}}

    OIDCScope "openid email profile"
    #OIDCRemoteUserClaim email
{{config}}

    <Location />
        AuthType openid-connect
        {% for username in vault_usernames %}
        Require claim email:{{vault_userdata[username].email}}
        {% endfor %}
        #Require valid-user

        {% for username in vault_usernames %}
        SetEnvIf OIDC_CLAIM_email "{{vault_userdata[username].email}}" REMOTE_USER={{username}}
        #SetEnvIfExpr "reqenv('REMOTE_USER') == '{{vault_userdata[username].email}}'" REMOTE_UID={{username}}
        {% endfor %}
    </Location>
</VirtualHost>