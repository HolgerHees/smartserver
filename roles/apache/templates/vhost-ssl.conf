<VirtualHost *:443>
	ServerName {{sub_domain}}.{{server_domain}}
	
    SSLEngine On
    SSLCertificateFile /etc/certbot/live/{{server_domain}}/fullchain.pem
	SSLCertificateKeyFile /etc/certbot/live/{{server_domain}}/privkey.pem

    Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains; preload"

    OIDCProviderMetadataURL {{vault_openid_connect_url}}
    OIDCClientID {{vault_openid_connect_client_id}}
    OIDCClientSecret {{vault_openid_connect_client_secret}}

    # OIDCRedirectURI is a vanity URL that must point to a path protected by this module but must NOT point to any content
    OIDCRedirectURI https://{{sub_domain}}.{{server_domain}}/redirect_uri
    OIDCCryptoPassphrase {{vault_openid_connect_passphrase}}

    OIDCScope "openid email profile"
    #OIDCRemoteUserClaim email

    #SetEnvIfExpr "reqenv('OIDC_CLAIM_email') == '.hees@gmail.com" REMOTE_USER=hhees
    
{{config}}

    <Location />
        AuthType openid-connect
        Require claim email:holger.hees@gmail.com
        #Require valid-user

        SetEnvIfExpr "env('OIDC_CLAIM_email') == 'holger.hees@gmail.com'" REMOTE_UID=hhees
    </Location>
</VirtualHost>