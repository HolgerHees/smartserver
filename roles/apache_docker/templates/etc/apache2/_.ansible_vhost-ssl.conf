Listen 443
Listen 10114

ServerName {{server_domain}}

Logformat "%t - %h - %u - \"%r\" - %s - %b (%D) - \"%{User-Agent}i\"" my_http_log
CustomLog "{{global_log}}apache2/access.log" my_http_log

AddType text/html .php

<FilesMatch \.php$>
    SetHandler application/x-httpd-php
</FilesMatch>

DirectoryIndex index.html
DirectoryIndex index.php

#php_value session.save_handler "files"
#php_value session.save_path    "/var/lib/php/session"
#php_value soap.wsdl_cache_dir  "/var/lib/php/wsdlcache"
        
SSLUseStapling On
SSLStaplingCache shmcb:{{global_tmp}}apache2/ssl_stapling(32768)
SSLSessionCache shmcb:{{global_tmp}}apache2/ssl_gcache_data(512000)

#NameVirtualHost *:443
<VirtualHost *:443>
	ServerName {{server_domain}}
	
	Include {{www_etc}}_.ansible.d/*.conf

    SSLEngine On
    SSLCertificateFile /etc/certbot/live/{{server_domain}}/fullchain.pem
	SSLCertificateKeyFile /etc/certbot/live/{{server_domain}}/privkey.pem

    DocumentRoot "{{htdocs_path}}"

    <Directory {{htdocs_path}}>
        Options +FollowSymLinks -SymLinksIfOwnerMatch +MultiViews
        AllowOverride None
        Require all granted
    </Directory>

	# If the domain (any domain) is not exactly mydomain.com...
	#RewriteCond %{HTTP_HOST} !^{{server_domain | regex_replace('\.','\\.')}}$ [NC]
	#RewriteRule (.*) http://{{server_domain}}$1 [L,R=301,QSA]
 
	<IfModule mod_headers.c>
      Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains; preload"
    </IfModule>
</VirtualHost>

<VirtualHost {{server_ip}}:10114>
	ServerName {{server_domain}}
	
    <LocationMatch "/.*">
        Require all denied
    </LocationMatch>

    <Location /rest>
        ProxyPass http://127.0.0.1:8080/rest
        ProxyPreserveHost on
        RequestHeader set X-Forwarded-Proto "https" env=HTTPS
        AuthName        "Marvin"
        AuthType        Basic
        AuthUserFile    {{htdocs_path}}.htpasswd
        <RequireAny>
            Require user alexa
        </RequireAny>
    </Location>
	
    SSLEngine On
    SSLCertificateFile /etc/certbot/live/{{server_domain}}/fullchain.pem
	SSLCertificateKeyFile /etc/certbot/live/{{server_domain}}/privkey.pem

    Header always set Strict-Transport-Security "max-age=15768000; includeSubDomains; preload"
</VirtualHost>
