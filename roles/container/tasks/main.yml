- name: install required fedora packages
  yum:
    name: [
        docker
        , python3-docker  # used by ansible docker module
        , podman
    ]
    state: present
  when: ansible_distribution == 'Fedora'
  notify: "restart docker"
  
#- name: modify fedora cgroup parameter on fedora
#  lineinfile:
#    state: present
#    dest: /etc/default/grub
#    backrefs: yes
#    regexp: '^(GRUB_CMDLINE_LINUX=(?!.*systemd\.unified_cgroup_hierarchy)\"[^\"]+)(\".*)'
#    line: '\1 systemd.unified_cgroup_hierarchy=0\2'
#  register: group_result
  
#- name: update group boot parameter on fedora
#  shell: "grub2-mkconfig -o /boot/grub2/grub.cfg"
#  when: ansible_distribution == 'Fedora' and group_result is changed

#- name: reboot to activate cgroup changes on fedora
#  shell: "sleep 5 && reboot"
#  async: 1
#  poll: 0
#  when: ansible_distribution == 'Fedora' and group_result is changed

#- name: wait for the reboot to complete on fedora
#  wait_for_connection:
#    connect_timeout: 20
#    sleep: 5
#    delay: 5
#    timeout: 300
#  when: ansible_distribution == 'Fedora' and group_result is changed
  

#- name: add suse zypper repository
#  zypper_repository:
#    name: Devel:Kubic (podman)
#    repo: 'http://download.opensuse.org/repositories/devel:/kubic/openSUSE_Leap_{{ansible_distribution_version}}/'
#    auto_import_keys: yes
#    priority: "100"
#    state: present
#  when: ansible_distribution == 'openSUSE Leap'

- name: install required suse packages
  zypper:
    name: [
        docker
        , python2-docker  # used by ansible docker module
        #, python3-docker  # used by ansible docker module
        , podman
#        , podman>=1.6.2
#        , cni>=0.7.1
#        , cni-plugins>=0.8.3
    ]
    state: present
  when: ansible_distribution == 'openSUSE Leap'

- name: set podman config
  lineinfile:
    path: /etc/containers/{{item.file}}
    regexp: '^[#]*{{item.field}}\s*='
    line: '{{item.field}}="{{item.value}}"'
    create: true
    owner: root
    group: root
    mode: 0640
  with_items:
    - { file: 'libpod.conf', field: 'static_dir', value: '{{global_lib}}libpod/storage/' }
    - { file: 'libpod.conf', field: 'tmp_dir', value: '{{global_tmp}}libpod/' }
    - { file: 'libpod.conf', field: 'cgroup_manager', value: "{{ 'systemd' if ansible_distribution == 'openSUSE Leap' else 'systemd' }}" }
    - { file: 'storage.conf', field: 'runroot', value: '{{global_tmp}}containers/storage/' }
    - { file: 'storage.conf', field: 'graphroot', value: '{{global_lib}}containers/storage/' }

- name: copy podman fluentd config
  template:
    src: "roles/container/templates/etc/fluent/_.ansible.d/podman.conf"
    dest: "/etc/fluent/_.ansible.d/podman.conf"
    owner: root
    group: root
    mode: 0640
  notify: "restart fluentd"
  tags: ['fluentd']  

- name: copy docker config
  template:
    src: "roles/container/templates/etc/docker/daemon.json"
    dest: "/etc/docker/daemon.json"
    owner: root
    group: root
    mode: 0644
  notify: "restart docker"

- name: copy docker fluentd config
  template:
    src: "roles/container/templates/etc/fluent/_.ansible.d/docker.conf"
    dest: "/etc/fluent/_.ansible.d/docker.conf"
    owner: root
    group: root
    mode: 0640
  notify: "restart fluentd"
  tags: ['fluentd']  
