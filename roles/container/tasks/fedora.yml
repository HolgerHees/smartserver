---
- name: prepare fedora
  hosts: all
  become: yes
  become_user: root
  tasks:
    - name: modify fedora cgroup parameter on fedora
      lineinfile:
        state: present
        dest: /etc/default/grub
        backrefs: yes
        regexp: '^(GRUB_CMDLINE_LINUX=(?!.*systemd\.unified_cgroup_hierarchy)\"[^\"]+)(\".*)'
        line: '\1 systemd.unified_cgroup_hierarchy=0\2'
      register: group_result
      
    - name: update grub boot parameter on fedora
      shell: "grub2-mkconfig -o /boot/grub2/grub.cfg"
      when: group_result is changed

    - name: reboot to activate cgroupsv1
      shell: "shutdown -r now && sleep 10"
      async: 0
      poll: 0
      ignore_errors: true
      when: group_result is changed

#    - name: reboot to activate cgroupsv1
#      shell: nohup bash -c "sleep 2s && shutdown -r now" &
#      when: group_result is changed

#    - name: wait for the reboot to complete
#      wait_for_connection:
#        timeout: 240
#        sleep: 5
#        delay: 20
#      when: group_result is changed
      
#    - name: debug
#      debug:
#        var: group_result
#        verbosity: 4

#    - name: reboot to activate cgroupsv1
#      shell: "sleep 2 && shutdown -r now && sleep 2"
#      async: 1
#      poll: 0
#      ignore_errors: true
#      when: group_result is changed

#    - name: wait for the reboot to complete
#      wait_for_connection:
#        connect_timeout: 20
#        sleep: 5
#        delay: 10
#        timeout: 300
#      when: group_result is changed
