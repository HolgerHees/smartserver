#- name:
#  debug:
#    msg: "{{device_files}}"

- name: "{{type}}: process files {{host}}"
  set_fact:
    device_files: |
      {
        {% for _host in device_files %}{% if host != _host %}
          '{{_host}}': {{ device_files[_host] | to_json }},
        {% endif %}{% endfor %}
        '{{host}}': {
          {% if host in device_files %}{% for file in device_files[host].values() %}
            '{{file["filename"]}}': { 'host': '{{file['host']}}', 'name': '{{file['name']}}', 'src': '{{file["src"]}}', 'filename': '{{file["filename"]}}' },
          {% endfor %}{% endif %}
          {% for feature in features %}
            {% for filepath in files %}
              {% if not 'config.yml' in filepath and (not host in device_files or not (filepath | regex_replace( path + feature['name'] + '/','')) in device_files[host]) %}
                {% if path + feature['name'] + '/' in filepath %}
                  '{{ filepath | regex_replace( path + feature['name'] + '/','') }}': { 'host': '{{host}}', 'name': '{{name}}', 'src': '{{filepath}}', 'filename': '{{ filepath | regex_replace( path + feature['name'] + '/','') }}' },
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        },
      }

#                '{{file}} | {{path + feature}}',
