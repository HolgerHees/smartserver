- name: prepare needed folder
  file:
    path: '{{item.path}}'
    state: directory
    owner: "{{item.user}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  with_items:
    - { user: "1000", group: "1000", mode: "u=rwx,g=rx,o=", path: "{{global_etc}}openwrt" }
    - { user: "1000", group: "1000", mode: "u=rwx,g=rx,o=", path: "{{global_etc}}openwrt/ap/" }

- name: synchronize deployment script
  synchronize:
    src: "templates/deploy.sh"
    dest: "{{global_etc}}openwrt/ap/deploy.sh"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
      - "--chmod=F750"

- name: copy deployment config
  template:
    src: "templates/deploy.env"
    dest: "{{global_etc}}openwrt/ap/{{item.host}}.env"
    owner: "root"
    group: "root"
    mode: "u=rw,g=r,o="
  with_items: "{{openwrt_devices}}"

- name: synchronize static configs
  synchronize:
    src: "templates/config_ap_static/"
    dest: "{{global_etc}}openwrt/ap/{{item.host}}/"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
      - "--chmod=D750,F640"
  with_items: "{{openwrt_devices}}"
      
- name: check for dynamic configs
  find:
    paths: "roles/openwrt/templates/config_ap_dynamic/"
    file_type: "file"
    recurse: yes
  delegate_to: 127.0.0.1
  register: dynamic_shared_file_result
  
- name: prepare dynamic configs
  set_fact: 
    dynamic_shared_files: |
      [
        {% for device in openwrt_devices %}
          {% for file in dynamic_shared_file_result.files %}
            { 'src': '{{file.path}}', 'dest': '{{global_etc}}openwrt/ap/{{device.host}}/{{file.path[42:]}}' },
          {% endfor %}
        {% endfor %}
      ]
      
- name: copy dynamic configs
  template:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
    owner: "root"
    group: "root"
    mode: "u=rwX,g=rX,o="
  changed_when: no
  with_items: "{{dynamic_shared_files}}"

- name: check for custom shared openwrt configs
  stat:
    path: "{{config_path}}vault/openwrt/shared/"
  register: custom_shared_config_directory
  delegate_to: 127.0.0.1

- name: synchronize custom shared static configs
  synchronize:
    src: "{{config_path}}vault/openwrt/shared/"
    dest: "{{global_etc}}openwrt/ap/{{item.host}}/"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
      - "--chmod=D750,F640"
  with_items: "{{openwrt_devices}}"
  when: "custom_shared_config_directory.stat.exists"

- name: check for custom host openwrt configs
  find:
    paths: "{{config_path}}vault/openwrt/{{item.host}}"
    file_type: "any"
  delegate_to: 127.0.0.1
  register: custom_config_directory
  with_items: "{{openwrt_devices}}"

- name: copy custom host openwrt configs
  synchronize:
    src: "{{config_path}}vault/openwrt/{{item.1.host}}/"
    dest: "{{global_etc}}openwrt/ap/{{item.1.host}}/"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
      - "--chmod=D750,F640"
  loop_control:
    index_var: index
  when: "custom_config_directory.results[index].matched > 0"
  with_indexed_items: "{{openwrt_devices}}"

- name: register webui
  vars:
    name: "openwrt"
    js_file: "templates/webui/openwrt.js"
    i18n_files: [ { language: "de", file: "templates/webui/openwrt.de.json" } ]
    icons: [ 'templates/webui/icons/openwrt_logo.svg' ]
  import_tasks: roles/apache_webui/tasks/add_webui.yml
