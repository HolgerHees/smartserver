- name: prepare needed folder
  file:
    path: '{{item.path}}'
    state: directory
    owner: "{{item.user}}"
    group: "{{item.group}}"
    mode: "{{item.mode}}"
  with_items:
    - { user: "1000", group: "1000", mode: "u=rwx,g=rx,o=", path: "{{global_etc}}openwrt" }
    - { user: "1000", group: "1000", mode: "u=rwx,g=rx,o=", path: "{{global_etc}}openwrt/ap/" }

- name: synchronize deployment script
  synchronize:
    src: "templates/deploy.sh"
    dest: "{{global_etc}}openwrt/ap/deploy.sh"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
      - "--chmod=F750"

- name: copy deployment config
  template:
    src: "templates/deploy.env"
    dest: "{{global_etc}}openwrt/ap/{{item.host}}.env"
    owner: "root"
    group: "root"
    mode: "u=rw,g=r,o="
  with_items: "{{openwrt_devices}}"

- name: synchronize static configs
  synchronize:
    src: "templates/config_ap_static/"
    dest: "{{global_etc}}openwrt/ap/{{item.host}}/"
    archive: no
    checksum: yes
    group: yes
    owner: yes
    perms: yes
    recursive: yes
    rsync_opts:
      - "--chown=root:root"
    #  - "--chmod=D750,F640"
  with_items: "{{openwrt_devices}}"
      
- name: check for dynamic configs
  find:
    paths: "roles/openwrt/templates/config_ap_dynamic/"
    file_type: "file"
    recurse: yes
  delegate_to: 127.0.0.1
  register: dynamic_shared_file_result
  
- name: prepare dynamic configs
  set_fact: 
    dynamic_shared_files: |
      [
        {% for device in openwrt_devices %}
          {% for file in dynamic_shared_file_result.files %}
            { 'name': '{{device.name}}', 'email': "{{root_email}}", 'is_ap': {{'1' if 'ap' in device.config.roles else '0'}}, 'src': '{{file.path}}', 'dest': '{{global_etc}}openwrt/ap/{{device.host}}/{{file.path | regex_replace('roles/openwrt/templates/config_ap_dynamic/','') }}' },
          {% endfor %}
        {% endfor %}
      ]
      
- name: check target paths
  file:
    dest: "{{item.dest | dirname}}"
    state: "directory"
  with_items: "{{dynamic_shared_files}}"

- name: copy dynamic configs
  template:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
    owner: "root"
    group: "root"
    mode: "u=rwX,g=rX,o="
  changed_when: no
  with_items: "{{dynamic_shared_files}}"

- name: check for custom shared ap configs
  find:
    paths: "{{config_path}}vault/openwrt/shared_ap/"
    file_type: "file"
    recurse: yes
  delegate_to: 127.0.0.1
  register: custom_shared_ap_file_result

- name: prepare custom shared ap configs
  set_fact:
    custom_shared_ap_files: |
      [
        {% for device in openwrt_devices %}
          {% if 'ap' in device.config.roles %}{% for file in custom_shared_ap_file_result.files %}
            { 'src': '{{file.path}}', 'dest': '{{global_etc}}openwrt/ap/{{device.host}}/{{file.path | regex_replace(config_path + 'vault/openwrt/shared_ap/','') }}' },
          {% endfor %}{% endif %}
        {% endfor %}
      ]

- name: check target paths
  file:
    dest: "{{item.dest | dirname}}"
    state: "directory"
  with_items: "{{custom_shared_ap_files}}"

- name: copy custom shared ap configs
  template:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
    owner: "root"
    group: "root"
    mode: "u=rwX,g=rX,o="
  changed_when: no
  with_items: "{{custom_shared_ap_files}}"

- name: check for custom host configs
  find:
    paths: "{{config_path}}vault/openwrt/{{item.host}}/"
    file_type: "file"
    recurse: yes
  delegate_to: 127.0.0.1
  register: custom_host_file_result
  with_items: "{{openwrt_devices}}"

- name: prepare custom host configs
  set_fact:
    custom_host_files: |
      [
        {% for result in custom_host_file_result.results %}
        {% for file in result.files %}
        { 'src': '{{file.path}}', 'dest': '{{global_etc}}openwrt/ap/{{file.path | regex_replace(config_path + 'vault/openwrt/','') }}' },
        {% endfor %}
        {% endfor %}
      ]

- name: check target paths
  file:
    dest: "{{item.dest | dirname}}"
    state: "directory"
  with_items: "{{custom_host_files}}"

- name: copy custom host configs
  template:
    src: "{{item.src}}"
    dest: "{{item.dest}}"
    owner: "root"
    group: "root"
    mode: "u=rwX,g=rX,o="
  changed_when: no
  with_items: "{{custom_host_files}}"

- name: register webui
  vars:
    name: "openwrt"
    js_file: "templates/webui/openwrt.js"
    i18n_files: [ { language: "de", file: "templates/webui/openwrt.de.json" } ]
    icons: []
  import_tasks: roles/apache_webui/tasks/add_webui.yml
