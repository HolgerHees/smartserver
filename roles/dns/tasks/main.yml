- name: install required fedora packages
  yum:
    name: [
        bind
    ]
    state: present
  notify: "restart named"
  when: ansible_distribution == 'Fedora'

- name: install required suse packages
  zypper:
    name: [
        bind
      , yast2-dns-server
    ]
    state: present
  notify: "restart named"
  when: ansible_distribution == 'openSUSE Leap'
  
- name: copy config
  template:
    src: "roles/dns/templates{{item.src}}"
    dest: "{{item.target}}"
    owner: root
    group: named
    mode: 0640
  with_items:
    - { ansible_distribution: ""              , src: "/etc/named.conf"              , target: "/etc/named.conf" }
#    - { ansible_distribution: "openSUSE Leap" , src: "/etc/named.d/forwarders.conf" , target: "/etc/named.d/forwarders.conf" }
#    - { ansible_distribution: "Fedora"        , src: "/etc/named.d/forwarders.conf" , target: "/etc/named/forwarders.conf" }
  when: item.ansible_distribution == "" or item.ansible_distribution == ansible_distribution
  notify: "restart named"
  
- name: Create a symbolic link on fedora
  file:
    src: /var/named/
    dest: /var/lib/named
    owner: root
    group: named
    state: link
  when: ansible_distribution == 'Fedora'
  
- name: prepare master folder on fedora
  file:
    path: "/var/lib/named/master/"
    state: directory
    owner: root
    group: named
    mode: 0770
  when: ansible_distribution == 'Fedora'

- name: copy var folder
  template:
    src: "roles/dns/templates/var/lib/named/master/{{item}}"
    dest: "/var/lib/named/master/{{item}}"
    owner: named
    group: named
    mode: 0640
  with_items:
    - "server_reverse.in-addr.arpa"
    - "server_forward"
  notify: "restart named"
  
- name: set resolv config on fedora
  lineinfile:
    path: /etc/sysconfig/network-scripts/ifcfg-eth0
    regexp: '^DNS1='
    line: 'DNS1=127.0.0.1'
  notify: "restart networkmanager"
  when: ansible_distribution == 'Fedora'

- name: set forwarder config on suse
  lineinfile:
    path: /etc/sysconfig/network/config
    regexp: '^{{item.key}}='
    line: '{{item.key}}="{{item.value}}"'
  with_items:
  #  - { key: "NETCONFIG_DNS_STATIC_SERVERS", value: "8.8.8.8 9.9.9.9"}
    - { key: "NETCONFIG_DNS_FORWARDER", value: "bind"}
  notify:
    - "refresh netconfig"
    - "restart named"
  when: ansible_distribution == 'openSUSE Leap'
