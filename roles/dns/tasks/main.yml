- name: install required packages => is_fedora
  yum:
    name: [
        bind
    ]
    state: present
  notify: "restart named"
  when: is_fedora|bool

- name: install required packages => is_suse
  zypper:
    name: [
        bind
      , yast2-dns-server
    ]
    state: present
  notify: "restart named"
  when: is_suse|bool
  
- name: copy config
  template:
    src: "templates/etc/named.conf"
    dest: "/etc/named.conf"
    owner: root
    group: named
    mode: 0640
  notify: "restart named"
  
- name: create a symbolic link => is_fedora
  file:
    src: /var/named/
    dest: /var/lib/named
    state: link
    follow: no
    owner: named
    group: named
  when: is_fedora|bool
  
- name: prepare needed folder
  file:
    path: "/var/lib/{{item}}"
    state: directory
    owner: named
    group: named
    mode: 0755
  with_items:
    - named/
    - named/master/ # is missing on fedora
    - named/dyn/ # is missing on fedora
  
- name: copy var folder
  template:
    src: "templates/var/lib/named/{{item}}"
    dest: "/var/lib/named/{{item}}"
    owner: named
    group: named
    mode: 0644
  with_items:
    - "master/server_reverse.in-addr.arpa"
    - "master/server_forward"
    - "127.0.0.zone"
    - "localhost.zone"
    - "root.hint"
  notify: "restart named"
  
- name: set selinux configuration => is_fedora
  sefcontext:
    target: "{{item.target}}"
    ftype: "{{item.ftype}}"
    setype: "{{item.setype}}"
    seuser: "system_u"
    state: present
  register: sefcontext_result
  with_items:
    - { ftype: "l", setype: "named_zone_t", target: "/var/lib/named" }
    - { ftype: "d", setype: "named_zone_t", target: "/var/named(/.*)?" }
    - { ftype: "f", setype: "named_conf_t", target: "/var/named(/.*)?" }
  when: is_fedora|bool

- name: reload selinux configuration => is_fedora and sefcontext changed
  shell: "restorecon {{item}}"
  with_items:
    - "/var/lib/named"
    - "-irv /var/named"
  when: is_fedora|bool and sefcontext_result.changed

- name: disable NetworkManager dns handling => is_fedora
  lineinfile:
    path: /etc/NetworkManager/NetworkManager.conf
    insertafter: '^\[main\]'
    regexp: '^{{item.field}}\s*='
    line: '{{item.field}}={{item.value}}'
  register: networkmanager_status
  with_items:
    - { field: "dns", value: "none" }
  when: is_fedora|bool

- name: netconfig update => is_fedora and NetworkManager changed
  systemd:
    name: NetworkManager
    state: restarted
  when: "is_fedora|bool and networkmanager_status.changed"

- name: disable netconfig dns handling => is_suse
  lineinfile:
    path: /etc/sysconfig/network/config
    regexp: '^{{item.field}}\s*='
    line: '{{item.field}}="{{item.value}}"'
  register: netconfig_status
  with_items:
    - { field: "NETCONFIG_DNS_POLICY", value: "" }
  when: is_suse|bool

- name: netconfig update => is_suse and netconfig changed
  shell: "netconfig update -f"
  when: "is_suse|bool and netconfig_status.changed"
  
- name: remove symlink => is_suse and netconfig changed
  file:
    path: /etc/resolv.conf
    state: absent
  when: "is_suse|bool and netconfig_status.changed"

- name: create file => is_suse and netconfig changed
  file:
    path: /etc/resolv.conf
    state: touch
    owner: named
    group: named
    mode: 0755
  when: "is_suse|bool and netconfig_status.changed"

- name: set dns config
  lineinfile:
    path: /etc/resolv.conf
    regexp: '^{{item.field}} \s*'
    line: '{{item.field}} {{item.value}}'
  with_items:
    - { field: "search", value: "{{server_domain}}"}
    - { field: "nameserver", value: "127.0.0.1"}
  notify:
    - "restart named"

# ***** FINALIZE *****
- name: register systemd service watcher
  vars:
    name: "named"
  import_tasks: roles/systemd_watcher/tasks/add_watcher.yml

- name: trigger service check handler
  vars:
    notify: "restart named"
    service: "named.service"
  import_tasks: roles/base/tasks/service_check.yml
