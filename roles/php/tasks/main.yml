- name: install required packages => is_fedora
  yum:
    name: [
        php 
      , php-mysqlnd
      #, php-cli              # pcntl & posix
      , php-devel 
      , php-pecl-imagick
      , php-pecl-redis
      , php-mbstring 
      , php-process          # posix 
      , php-pecl-zip 
      , php-gd 
      , php-pear-Net-Curl
      , php-common           # openssl, fileinfo, ctype & iconv
      , php-json             
      , php-xml              # dom, xmlwriter, xmlreader
      , php-intl             
      , php-pecl-apcu
      , php-opcache          
      , systemd-devel         # php-systemd => nextcloud
    ]
    state: present
  notify: "restart apache"
  when: is_fedora|bool
  
- name: install required packages => is_suse
  zypper:
    name: [
        php7 
      , php7-mysql 
      #, php7-pcntl 
      , php7-devel 
      , php7-imagick
      , php7-redis 
      , php7-mbstring 
      , php7-posix            # nextcloud
      , php7-zip 
      , php7-gd 
      , php7-curl 
      , php7-openssl 
      , php7-fileinfo
      , php7-json             # phpmyadmin
      , php7-ctype            # nextcloud
      , php7-dom              # nextcloud
      , php7-iconv            # nextcloud
      , php7-intl             # nextcloud
      , php7-xmlwriter        # nextcloud
      , php7-xmlreader        # nextcloud
      , php7-APCu             # nextcloud & resize.php
      , php7-opcache          # nextcloud
      , systemd-devel         # php-systemd => nextcloud
    ]
    state: present
  notify: "restart apache"
  when: is_suse|bool
  
#- shell: "pecl info inotify"
#  failed_when: "'command-not-found' in inotify_installed.stderr"
#  changed_when: False
#  register: inotify_installed
        
#- name: install inotify pecl module
#  pear:
#    name: pecl/inotify
#    state: present
#  when: inotify_installed.rc == 1
#  notify: "restart apache"
  
# nextcloud
- name: "clone php-systemd git" 
  git:
#    accept_hostkey: yes
    repo: 'https://github.com/systemd/php-systemd.git'
    dest: '{{global_build}}php-systemd'
#    force: yes
    version: 'master'
  register: clone_status
  
# nextcloud
- name: "install php-systemd => clone status changed" 
  shell: '{{ item }}'
  args:
    chdir: '{{global_build}}php-systemd'
  with_items:
    - 'phpize'
    - './configure --with-systemd'
    - 'make'
    - 'make install'
  notify: "restart apache"
  when: clone_status.changed
  
- name: copy config
  template:
    src: roles/php/templates/etc/php7/conf.d/{{item}}
    dest: "/etc/{{ 'php7/conf.d/' if is_suse|bool else 'php.d/90-' }}{{item}}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - apcu.ini
#    - inotify.ini
    - systemd.ini
  notify: "restart apache"
    
- name: prepare opcache config
  lineinfile:
    path: /etc/{{ 'php7/cli/' if is_suse|bool else '' }}php.ini
    regexp: '^\[opcache\]'
    line: '[opcache]'

- name: set cli config
  import_tasks: roles/php/tasks/php_ini.yml
  vars:
    php_ini_file: "/etc/{{ 'php7/cli/' if is_suse|bool else '' }}php.ini"

- name: copy imagick config
  template:
    src: roles/php/templates/etc/ImageMagick-7/policy.xml
    dest: /etc/ImageMagick-{{ '7' if is_suse|bool else '6' }}/policy.xml
    owner: root
    group: root
    mode: 0644
  notify: "restart apache"

#cp /etc/systemd/system/lognotifier.service
#???cp /etc/systemd/system/doorkeeper.service
#systemctl start lognotifier
#systemctl enable lognotifier
#???systemctl start doorkeeper
#???systemctl enable doorkeeper

